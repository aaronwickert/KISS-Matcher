name: Compilation Issue Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-issue-76-cmake-version-compatibility:
    name: Test Issue #76 - CMake Version Compatibility
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            cmake_version: "3.20"
            expect_failure: false
          - os: ubuntu-22.04
            cmake_version: "3.24"
            expect_failure: false
          - os: ubuntu-24.04
            cmake_version: "3.28"
            expect_failure: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies with FLANN
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc \
            g++ \
            build-essential \
            libeigen3-dev \
            python3-pip \
            python3-dev \
            cmake \
            git \
            ninja-build \
            libflann-dev \
            libtbb-dev \
            liblz4-dev

      - name: Install specific CMake version
        if: matrix.cmake_version != 'system'
        run: |
          # Remove system cmake first
          sudo apt-get remove -y cmake cmake-data || true

          # Install specific CMake version
          if [ "${{ matrix.cmake_version }}" = "3.20" ]; then
            wget https://github.com/Kitware/CMake/releases/download/v3.20.6/cmake-3.20.6-linux-x86_64.tar.gz
            tar -xzf cmake-3.20.6-linux-x86_64.tar.gz
            sudo cp -r cmake-3.20.6-linux-x86_64/* /usr/local/
          elif [ "${{ matrix.cmake_version }}" = "3.24" ]; then
            wget https://github.com/Kitware/CMake/releases/download/v3.24.4/cmake-3.24.4-linux-x86_64.tar.gz
            tar -xzf cmake-3.24.4-linux-x86_64.tar.gz
            sudo cp -r cmake-3.24.4-linux-x86_64/* /usr/local/
          elif [ "${{ matrix.cmake_version }}" = "3.28" ]; then
            wget https://github.com/Kitware/CMake/releases/download/v3.28.1/cmake-3.28.1-linux-x86_64.tar.gz
            tar -xzf cmake-3.28.1-linux-x86_64.tar.gz
            sudo cp -r cmake-3.28.1-linux-x86_64/* /usr/local/
          fi

          # Update PATH and verify
          export PATH=/usr/local/bin:$PATH
          echo "/usr/local/bin" >> $GITHUB_PATH
          cmake --version

      - name: Test Python package build (reproduces issue #76)
        id: python_build_test
        continue-on-error: true
        working-directory: python/
        run: |
          # Ensure we're using the correct cmake
          export PATH=/usr/local/bin:$PATH
          cmake --version

          # Install Python build dependencies
          python3 -m pip install --upgrade pip wheel setuptools
          python3 -m pip install scikit-build-core pybind11 numpy

          echo "Attempting to build Python package with CMake ${{ matrix.cmake_version }}..."

          # Set environment variables for the build
          export CMAKE_ARGS="-DUSE_SYSTEM_EIGEN3=ON -DUSE_SYSTEM_TBB=ON -DUSE_SYSTEM_ROBIN=ON"

          # This should reproduce the CMake version compatibility issue
          python3 -m pip install -e . --verbose 2>&1 | tee build_log.txt

          # Check for specific error patterns from issue #76
          if grep -q "CMake.*version.*earlier than.*3\.5" build_log.txt; then
            echo "ERROR: Detected CMake version compatibility issue from #76"
            exit 1
          fi

          # Check for other common CMake errors
          if grep -q "CMake Error" build_log.txt; then
            echo "ERROR: CMake error detected"
            grep "CMake Error" build_log.txt
            exit 1
          fi

          echo "Python package build completed successfully"

      - name: Test Python import
        if: steps.python_build_test.outcome == 'success'
        working-directory: python/
        run: |
          python3 -c "
          try:
              import kiss_matcher
              print('✅ Successfully imported kiss_matcher')
              print(f'Available functions: {[x for x in dir(kiss_matcher) if not x.startswith(\"_\")]}')
          except ImportError as e:
              print(f'❌ Failed to import kiss_matcher: {e}')
              exit(1)
          "

      - name: Report test result
        run: |
          if [ "${{ matrix.expect_failure }}" = "true" ]; then
            # For this test, we EXPECT failure (reproducing issue #76)
            if [ "${{ steps.python_build_test.outcome }}" = "failure" ]; then
              echo "✅ CMake ${{ matrix.cmake_version }} correctly failed as expected (reproduces Issue #76)"
            else
              echo "❌ CMake ${{ matrix.cmake_version }} should have failed but didn't - Issue #76 may be fixed"
              exit 1
            fi
          else
            # For these tests, we expect success
            if [ "${{ steps.python_build_test.outcome }}" = "failure" ]; then
              echo "❌ CMake ${{ matrix.cmake_version }} on ${{ matrix.os }} failed to build Python package"
              exit 1
            else
              echo "✅ CMake ${{ matrix.cmake_version }} on ${{ matrix.os }} successfully built Python package"
            fi
          fi


  test-cmake-policy-compatibility:
    name: Test CMake Policy Compatibility
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test CMake policies across versions
        run: |
          # Test various CMake versions and their policy handling
          echo "Testing CMake policy compatibility..."

          # Create test CMakeLists.txt that mimics KISS-Matcher's dependency handling
          mkdir -p /tmp/cmake_policy_test
          cd /tmp/cmake_policy_test

          cat > CMakeLists.txt << 'EOF'
          # Test different minimum required versions like in KISS-Matcher
          cmake_minimum_required(VERSION 3.16...3.26)
          project(cmake_policy_test)

          # Test the policy that affects FetchContent (from find_dependencies.cmake)
          if(CMAKE_VERSION VERSION_GREATER 3.24)
            cmake_policy(SET CMP0135 OLD)
          endif()

          # Test FetchContent with ROBIN like in the actual project
          include(FetchContent)
          FetchContent_Declare(
            robin
            URL https://github.com/MIT-SPARK/ROBIN/archive/refs/tags/v.1.2.4.tar.gz
          )
          FetchContent_GetProperties(robin)
          if(NOT robin)
            FetchContent_Populate(robin)
            message(STATUS "Successfully populated ROBIN dependency")
          endif()
          EOF

          # Test configuration
          cmake -S . -B build -G Ninja
          echo "CMake policy compatibility test passed"

  summary:
    name: Compilation Issue Test Summary
    runs-on: ubuntu-22.04
    needs: [test-issue-76-cmake-version-compatibility, test-cmake-policy-compatibility]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Compilation Issue Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-issue-76-cmake-version-compatibility.result }}" = "success" ]; then
            echo "✅ Issue #76 (CMake version compatibility): Tests completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "   - CMake 3.20: Correctly failed (reproduces issue)" >> $GITHUB_STEP_SUMMARY
            echo "   - CMake 3.24+: Successfully builds" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Issue #76 (CMake version compatibility): Tests failed unexpectedly" >> $GITHUB_STEP_SUMMARY
          fi

          echo "⚠️ Issue #77 (ROS2 ROBIN targets): SKIPPED - Test removed for simplification" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-cmake-policy-compatibility.result }}" = "success" ]; then
            echo "✅ CMake Policy Compatibility: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ CMake Policy Compatibility: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "These tests specifically target the compilation issues reported in:" >> $GITHUB_STEP_SUMMARY
          echo "- [Issue #76](https://github.com/MIT-SPARK/KISS-Matcher/issues/76): CMake version compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- [Issue #77](https://github.com/MIT-SPARK/KISS-Matcher/issues/77): ROS2 ROBIN targets missing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The workflow validates that newer CMake versions (3.24+) work while older versions (3.20) fail as expected." >> $GITHUB_STEP_SUMMARY
